## I. File Download 개요
### File Download 개요
#### 취약점 개요
접근할 수 없는 디렉토리에 접근해서 파일을 다운로드 받는 취약점  
url 경로에 `../`를 입력하여 접근

#### 발생 원인
- 파일 경로와 파일명이 노출
    - 파일 다운로드 시 해당 파일의 절대경로 또는 상대경로가 노출된 경우
- 파일 경로와 파일명 필터링 미비
    - ../를 이용한 web root 상위 디렉토리 접근이 가능한 경우
    - 다운로드 모듈에 경로가 노출되지 않더라도 그 구조가 단순하여 파라미터 변조를 통해 접근이 허용되지 않은 파일에 접근이 가능한 경우

#### 예상되는 피해 예시
- 서버의 시스템 파일 유출
- 소스코드 노출 
    - 암복호화
    - DB connection 파일 등

DB에 실제 경로와 파일 명을 가지고 있다가 검색해서 전송하는 로직을 써야 안전함

### FileDownlaod 영향
1. 다운로드 경로와 대상 조작 후 요청 
    - 프록시의 repeater를 이용해서 동일한 요청을 반복해서 보낼 수 있음
2. 허가되지 않은 파일에 접근

### 비인가 파일 다운로드
타인의 게시물 첨부파일을 변조한 URL로 획득 (권한체크와 관련된 부분)
.....?pcode=101&cate=recruit  
pcode 값을 변경하여 타인의 지원서 획득 가능  

<br>

## III. File Download 진단 방법
### 진단 방법
- 업로드 된 파일의 속성 정보를 확인하여 해당 파일의 경로 노출 여부를 확인
- 사용되는 파라미터 중 변조에 의해 다른 파일에 접근이 가능한 부분이 있는지 확인
- 파일명으로 다운로드 하는 것을 확인 후 ../ 삽입
- 다운받은 주요 파일을 바탕으로 시스템 정보 수집

### 우회 기법
- Windows
    - 경로 추적 : 더블 인코딩 (%255c - 네 자리가 한 글자)
    - IIS 원격 실행 멸령어 (실행가능한 CGI 프로그램을 디코딩할 때 2번 함)
    - JEUS 디렉토리 인덱싱 
        - %23을 붙이고 파일명을 붙이면 /etc에서 검색 함
        - %23aaa : 소스 파싱(소스코드 노출됨)
- 공통
    - URL 인코딩
    - 유니코드 인코딩
    - %00(널바이트) 파일 다운로드
    - 특수문자 변형 ..././..././..././etc/passwd 등으로 사용
    - WAF 등에서 문자열 기반 필터링을 하는 경우가 많기 때문에

<br>

## IV. 보안 대책
### 보안 대책
- 안전한 코딩
    - 파일명과 경로명을 DB에서 관리
    - 경로 관련 필터링 로직 구현
    - 다운로드 시 권한 체크
- 파일 다운로드 취약점은 업롣, 다운로드 모두 조치해야 하고 DB 테이블을 수정해야 함
- 파일 다운로드와 업로드 취약점은 서로 연계되어 있음

### 추가 보안 대책
- 웹 어플리케이션을 통해 Web root 상위로 접근되지 않도록 권한 설정
- 경로 관련 문자열 탐지 시 삭제 처리
- 경로를 의미하는 파라미터를 사용하지 않음으로써 임의의 경로에 대한 접근을 차단
- 업로드 디렉토리 이외에는 접근되지 않도록 차단
- 파일 업로드 시 첨부파일에 대한 SEQ 번호 부여 후 다운로드 시 SEQ 번호를 기준으로 파일 접근
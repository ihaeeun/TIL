## I. 파일 업로드 개요
### 개요
#### File Upload
- 웹 사이트의 파일 업로드 기능을 이용하여 인가받지 않은 파일을 서버에 임의로 업로드하는 공격
- 웹 쉘 형태의 파일을 업로드 후 실행하면 서버의 자원을 장악할 수 있음
- 페이지를 변조하여 접속하는 클라이언트들에게 악성코드 배포 가능

#### 원인
- 공격자는 악의 적인 파일을 업로드 시키고 업로드 경로를 확인하여 악의적인 스크립트를 실행

### File Upload 시나리오
1. 취약한 웹 서버에 휍 쉘 업로드
2. 업로드한 파일에 접근하여 웹 쉘 실행
3. 내부망 시스템 장악
4. Reverse Connection을 맺어 내부망 정보 탈취

<br>

## II. Web Shell
### Web Shell
#### Web Shell
- 웹 쉘은 원격에서 웹 서버 명령을 수행할 수 있도록 해주는 웹 스크립트 언어로 작성한 파일
- 웹 스크립트 언어(서버사이드 언어)는 웹 서버에 명령어를 실행할 수 있는 함수, 문법을 지원

#### 종류
- Single-Line Webshell
- 다중 웹 쉘
- 다중 분할 웹 쉘 : 조각된 데이터 파라미터를 웹 서버에서 재조리
- Image 웹 쉘 : 이미지 파일 구조 내에 공격 코드 삽입 (스테가노그라피)

아무 웹 쉘이나 사용하면 안됨. 제작자의 서버로 정보가 넘어가는 경우가 많음  
프로젝트 종료시에 담당자에게 파일 삭제를 요청해야 함

<br>

## III. 업로드 방법과 보안 대책
### 어떻게 업로드 할 것인가?
#### 파일 업로드 필터링에 따른 업로드 우회 방법
- 클라이언트 (블랙리스트, 화이트리스트)
- 서버 (블랙리스트, 화이트리스트)
    - 화이트리스트 중 파일 확장자를 이용하는 것이 가장 안전함
    - Content-Type 헤더 이용

#### 시스템 취약점으로 업로드
- IIS6.x 미만 버전 : 세미콜론 취약점. 정상적인 확장자를 입력하고 ;를 붙이고, 허용이 된 확장자를 입력할 경우 뒤의 확장자만 보고 허용하는데, IIS6.x 미만은 ;가 종결 문자여서 앞의 확장자로 인식함
- 리눅스 종단 문자(%00, %zz)

### 서버 측 파일 확장자 블랙리스트 필터링 우회
- 대소문자 조함
- 동일 의미의 확장자

#### cf) 필터링 위치 확인 방법
- 프록시 이용
- 프록시에서 intercept 했을 때 브라우저에서 작동하면 클라이언트 측 필터링, 프록시에서 서버의 response가 잡히면 서버측

### 서버 측 Content-Type 필터링 우회
- 헤더의 Content-Type 변경

### 시스템 취약점으로 업로드
#### IIS 파일 세미 콜론 파싱 취약점을 이용한 우회
- IIS 6.x 미만 버전인 경우 발생
- 확장자 뒤에 `;.` 허용된 확장자 형태를 추가하여 우회

#### 리눅스 종단 문자를 이용한 우회
- %00, %zz는 종단문자로서 리눅스 계열의 서버에서 우회 가능
- webShell.jsp%00.jpg 처럼 업로드하면 서버에서 webSell.jsp로 인식

#### 보안대책
- 서버측에서 특수문자가 포함되어 있는지 검즈ㅡㅇ

### 기타 보안 대책과 우회
#### 확장자 필터링 시 확장자를 삭제하는 경우
- .jsp.jsp와 같이 .jsp 확장자를 두 번 사용
#### 파일 사이즈 제한
- 사이즈를 줄인 한 줄 웹소ㅞㄹ 이용

<br>

## IV. 경로 확인과 보안 대책
### 업로드 파일 경로 확인과 보안 대책
#### 확인 방법 예식
- 업로드 성공 시 반환되는 Response 패킷 확인
- 이미지 속성 보기 시 절대 경로 확인
- 게시판에 포함된 js 파일 내 주석이나 코드에 포함된 절대 경로 확인
- 파일 업로드 시 서버 오류에 포함된 절대 경로 확인
- 추측을 통해 절대 경로 확인 

#### 보안 대책 - 경로명, 파일명 노출 방지
- 파일 경로와 파일 명을 데이터베이스에서 관리 
    - 업로드 시 파일 rename : 업로드 시 파일 이름으ㅡㄹ 해커가 추적할 수 없는 파일 이름/sequence num으로 업로드

#### 실행 권한 제거
- 업로드 경로와 웹 루트 디렉토리 분리
    - 파일 저장 경로를 웹 루트의 밖에 위치시킴
- 업로드 디렉토리의 실행권한 제거

```
모의해킹을 위해서는 파이썬 공부하면 도움이 많이 됨
모바일 진단에서도 파이썬 많이 활용
취약점 점검이 끝난 뒤, 취약점을 이용해서 공격을 해달라는 요청을 받을 때 파이썬으로 작성해서 실행함
실질적인 임팩트를 위해 
```
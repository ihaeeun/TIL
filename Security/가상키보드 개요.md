# **가상키보드**
## 동작원리  
숫자 또는 문자가 표시된 가상키패드 이미지(또는 플래시 파일)와 이를 처리하기 위한 스크립트 언어로 작성된 스크립트 파일을 서버에서 이용자 PC로 전송하고, 이용자가 마우스 장치를 이용해 입력한 정보를 서버로 전송하는 구조  
1. 가상키보드 사용 요청 (Client > Server)
2. 가상키보드 설치 (Client < Server)  
암호화 및 데이터 처리 스크립트, 가상키패드 이미지
3. 가상키보드 데이터 전송 (Client < Server)
가상키보드 데이터 Key 값 전송 등
4. 가상 키보드 사용 (Client)
5. 가상 키보드 입력 데이터 전송(Client > Server)
<img src="image/PC기반 가상키보드 주요 흐름 예.png">

<br>

## 주요 보안 위협
### 1. 네트워크 계층
- 네트워크 스니핑
- 세션 도용
- 중간자 공격
- 재전송 공격

### 2. 가상키보드 모듈
- **웹 브라우저 중간자 공격**  
: 웹 브라우저로 전송된 웹페이지 위변조
- **역공학 공격**  
: 대상 소프트웨어에서 특정 지식을 추출하여 데이터 추출 및 위변조
- **마우스 클릭 재생 공격**  
: 가상 키패드 이미지와 클릭된 마우스 X, Y 좌표 값을 절취한 후, 서로 다른 세션 또는 로그인 시 기존 저장된 좌표값을 재생하여 인증을 우회하는 기법  
- **인터페이스 중간자 공격**  
: 모듈과 상호 연동되는 각종 인터페이스를 후킹하여 전송되는 데이터의 열람 또는 위변조에 사용되는 기법

### 3. 단말 영역(시스템) 환경
- 메모리 해킹
- 화면을 통한 데이터 노출
- 키보드 이벤트 내용 절취

<br>

## 보안 요구사항
### 1. 단말 영역 
#### a. 프로세스 영역
> *__가상키보드 모듈이 구동하는 환경적 요소__ (브라우저 형태 / 바이너리 어플리케이션 형태 등)*
- DOM, BHO, COM 등 웹 브라우저 영역 또는 기타 통신 인터페이스에서 주요 비밀 정보에 대한 정보유출이 없어야 한다.
* 보안 프로그램에 할당된 메모리 영역에서 주요 비밀 정보에 대한 정보 유출이 없어야 한다.
- 가상키패드 이용 시 키보드 메시지 후킹 또는 유사 기법 등에서 안전하게 보호되어야 한다.
#### b. 보안프로그램 영역
> *가상 키보드 모듈 자체 요소. __가상 키보드 모듈이 가지고 있는 보안성__.*
- 가상키보드 암호 모듈에 의해 중요 정보를 암호화 한 이후 해당 암호문에 대한 복호화 과정이 수행되지 않아야 한다.
- 가상 키보드 암호 모듈은 공인된 암호 알고리즘으로 구성되어야 하며, 이를 통해 구현된 암호 알고리즘은 검증기관으로부터 검증받아야 한다.
- 가상키보드 암호키 공유 또는 갱신 중 가상키보드 암호키에 대한 정보 유출이 없어야 한다.
- 가상키보드에서 사용되는 매 세션은 혼용(random) 방식을 제공해야 한다.
- 한 세션에서 사용된 암호화 된 데이터는 다른 세션에서 재사용되면 안된다.
- 가상 키보드에서 사용된 데이터는 단말에 저장하면 안된다.
- 가상키패드는 random 방식을 제공해햐 하며, 해당 방법의 유추가 어려워야 한다.
- 가상키패드는 화면 저장 기술 또는 유사 방지 기술에 의해 보호되어야 한다.
- 가상 키보드를 통해 입력한 정보는 단말에 저장하면 안된다.

### 2. 데이터 전송 영역
- 이기종 보안 모듈 간 데이터 전송 시 주요 비밀정보 및 가상 키보드 암호키에 대한 정보유출이 없어야 한다.
- 클라이언트 - 서버 간 데이터 전송 시 데이터는 암호화 또는 이에 준하는 수준으로 전송해야 한다.

### 3. 서버 영역
- 가상키보드 복호모듈에 의해 복호화 과정을 정상적으로 처리해야 한다.
- 중요 정보가 단말 또는 네트워크 구간에서 위변조 되는 경우 리를 감지하여 비정상 거래로 처리해야 한다.

<br>

## 키보드 해킹 기법에 대한 대응 기술 분석
- 사용자의 키보드 입력 값의 자리수 노출 방지  
    - 기존 시스템 메시지 대기열에는(System Message Queue)에는 NULL 값을 제공하여 어떠한 키입력도 감지할 수 없도록 설계
    - 보안 키보드 드라이버와 응용프로그램에 연결된 보안 입력창 제어부 간의 직접 통신을 통해 화면에 특수문자를 표시함으로써 사용자에게 키 입력 여부 표시

- 해킹 성공시에도 원래 입력값 노출 방지
    - 보안 키보드 드라이버는 암호화 알고리즘을 적용하여 키보드 입력값을 암호화 (AES, SEED 등 대칭 키)
    - 암호화된 입력값을 직접 보안 입력창 제어부로 전송하여 웹 브라우저 등 응용 프로그램에 전달

- 매번 다른 암호키로 입력값 아모화
    - 사용자가 입력창을 선택할 때마다 서로 다른 키테이블을 생성하고 보안 키보드 드라이버를 설치하도록 설계
    - 다른 창이 선택되면 보안 키보드 드라이버를 자동으로 제거하여 다른 프로그램과의 충돌 방지

- 디버깅 및 변조 방지
    - 키보드 보안 프로그램을 구성하는 프로그램 파일들을 암호화함으로써 파일 분석을 통한 우회 및 무력화 공격 사전 방지




<br><br><br><br>
##### cf) 관련 용어
#### 후킹 (hooking)
운영체제나 응용 소프트웨어 등의 각종 컴퓨터 프로그램에서 소프트웨어 구성 요소 간에 발생하는 함수 호출, 메시지, 이벤트 등을 중간에서 바꾸거나 가로채는 명령, 방법, 기술이나 행위. 이때 간섭된 함수 호출, 이벤트, 또는 메시지를 처리하는 코드를 hook라고 한다.   
크래킹할 때 크래킹 대상 컴퓨터의 메모리 정보, 키보드 입력 정보 등을 빼돌리기 위해서 사용되기도 한다. 


<br><br>
[참조]  
_표준초안-가상키보드 보안 요구사항_  
_키보드 해킹기법 및 대응기술 분석_ 